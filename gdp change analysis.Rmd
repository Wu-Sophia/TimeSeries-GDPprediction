---
title: "GDP change analysis"
author: "Sophia Wu"
date: "`r Sys.time()`"
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '6'
  github_document: 
    toc: yes
    toc_depth: 6
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# *******Libraries*******
```{r message=FALSE, warning=FALSE}
library(tswge)
library(tidyverse)
library(ggplot2)
library(tseries)
library(kableExtra)
library(knitr)
```

#  *******Introduction*******
From Federal Reserve Economic Data, we see GDP changes every year.What is the economic cycle in the US? Are we able to predict the GDP change? Are there any significant variables causing GDP changes? Using Time series will help us analyze the important insights and predict the future trend.


#  *******Data Source*******
All data was downloaded from [Federal Reserve Economic Data (FRED) Repository](https://fred.stlouisfed.org/) It contains 75 years quarterly data from 1947 to 2021, 6 variables listed below:
6 columns as below:
*Date;
*GDP per capita;
*Income receipt;
*gross income;
*Profit before tax;
*gdp change.
Response variable is gdp change.

```{r}
# import US GDP data set
data <- read.csv("~/DS 6373 Time Series/TS Project2021/data/usgdp.csv")
data %>%  glimpse()
```


```{r}
# remove empty data
data <- na.omit(data)
```


#  ***check data stationarity ***
```{r, echo=FALSE}
#plot 75 years GDP Percent change from preceding period quarterly
plotts.sample.wge(data$gdp.change)

```

#  ***Condition 1: Constant Mean ***

* Wandering and oscillating behavior
* Only one realization not knowing much
* The assumption of constant mean seems like not appear to be violated.


#  ***Condition 2: Constant Variance ***
It is tough to confirm whether there is constant variance since we only have one realization. It seems like there is some tendency to make big jumps at the end of the period, indicating non-constant variance over time.


# ***Condition 3: Constant Autocorrelation ***
The first half of acf seems like little different from the second half of acf, but not much.
```{r}
# check the 1st half of acf for condition 3
acf(data$gdp.change[1:148])
```
```{r}
# check the 2nd half of acf for condition 3
acf(data$gdp.change[149:296])
```


#  ***Conclusion***
* Based on the above analysis, there is some evidence showing non-stationary.  But GDP change might be possibly stationary in the long term. We will analyze it using both stationary and non-stationary models.


#  ***Stationary model***

```{r}
# AIC and BIC both select ARMA(0,2) and ARMA(2,0), showing ARMA(0,2) and ARMA(2,0) might be good fitting stationary models. 
aic5.wge(data$gdp.change, p=0:5, q=0:5)
```

```{r}
aic5.wge(data$gdp.change,type = "bic", p=0:5, q=0:5)
```
```{r}
aic5.wge(data$gdp.change,type = "aic", p=0:5, q=0:5)
```
```{r}
#aic and bic pick ARMA(2,0)

lmfit=lm(data$gdp.change~data$GDP.per.capita+data$Income.receipt+data$gross.income, data = data)
AIC(lmfit)  #1742.12

```

# ***Model ID ARMA(2,0)***


```{r}
# Let's test Stationary model ARMA(2,0)

AR2 = est.ar.wge(data$gdp.change,p=2)
```
```{r}
ljung.wge(AR2$res)
ljung.wge(AR2$res, K = 48)
f_AR2 = fore.arma.wge(data$gdp.change,phi = AR2$phi,n.ahead = 12,limits = F, lastn = T)

```


```{r}
ASE_AR2 = mean((data$gdp.change[(length(data$gdp.change)-11):length(data$gdp.change)] - f_AR2$f)^2)

ASE_AR2
```


```{r}


#Compare Spectral Densities
sims = 5
SpecDen = parzen.wge(data$gdp.change, plot = "FALSE")
plot(SpecDen$freq,SpecDen$pzgram, type = "l", lwd = 6)

for( i in 1: sims)
{
   SpecDen2 = parzen.wge(gen.arma.wge(297, phi = AR2$phi, plot ="FALSE"), plot = "FALSE")
   lines(SpecDen2$freq,SpecDen2$pzgram, lwd = 2, col = "red")
}

```

```{r}

#Compare ACFs
sims = 5
ACF = acf(data$gdp.change, plot = "FALSE")
plot(ACF$lag ,ACF$acf , type = "l", lwd = 6)

for( i in 1: sims)
{
   ACF2 = acf(gen.arma.wge(297, phi = AR2$phi, plot = "FALSE"), plot = "FALSE")
   lines(ACF2$lag ,ACF2$acf, lwd = 2, col = "red")
}
```


```{r}

#Compare Generated Realizations 


AR2gen = gen.arma.wge(297,phi = AR2$phi, vara = AR2$avar)

plotts.sample.wge(AR2gen)
```

```{r}
# MODEL ARMA(0,2)

MA2 = est.arma.wge(data$gdp.change,q=2)
MA2
```
```{r}
ljung.wge(MA2$res)
ljung.wge(MA2$res, K = 48)
f_MA2 = fore.arma.wge(data$gdp.change,phi = MA2$phi,n.ahead = 12,limits = F, lastn = T)

```


```{r}
ASE = mean((data$gdp.change[(length(data$gdp.change)-11):length(data$gdp.change)] - f_MA2$f)^2)

ASE
```

#  ***Non-stationary model***
```{r}
x=data$gdp.change
#difference the data
xd1.dif=artrans.wge(x,phi.tr=1)
#xd1.dif is the differenced data
plotts.sample.wge(xd1.dif)
```


```{r}
#run aic5.wge with difference data, it selects ARMA(5,0)
aic5.wge(xd1.dif,type = "bic")
```
```{r}
aic5.wge(xd1.dif,type = "aic")
```
```{r}
# AIC and BIC picks p=5
fitarima=arima(data$gdp.change,order=c(5,1,0),xreg=cbind(data$GDP.per.capita,data$Income.receipt,data$gross.income))
fitarima
AIC(fitarima) #1718.626
```

# ***Model ID ARIMA(5,1,0)***

```{r}

# we get ARIMA(5,1,0)
ARIMA50= est.arma.wge(xd1.dif,p = 5, q=0)

```
```{r}
ljung.wge(ARIMA50$res)
ljung.wge(ARIMA50$res, K = 48)
f_x9arma=fore.arma.wge(data$gdp.change,phi=ARIMA50$phi,n.ahead = 12,limits = F, lastn = T)

#f_x9arma = fore.aruma.wge(data$gdp.change,s = 9,phi =x_9_arma$phi,n.ahead =2,limits = F, lastn = T)

ASE = mean((data$gdp.change[(length(data$gdp.change)-11):length(data$gdp.change)] - f_x9arma$f)^2)

ASE
```


```{r}
ASE = mean((data$gdp.change[(length(data$gdp.change)-11):length(data$gdp.change)] - f_x9arma$f)^2)

ASE
```
```{r}
#Compare Spectral Densities
sims = 5
SpecDen = parzen.wge(data$gdp.change, plot = "FALSE")
plot(SpecDen$freq,SpecDen$pzgram, type = "l", lwd = 6)

for( i in 1: sims)
{
   SpecDen3= parzen.wge(gen.arma.wge(295, phi = ARIMA50$phi, plot ="FALSE"), plot = "FALSE")
   lines(SpecDen3$freq,SpecDen3$pzgram, lwd = 2, col = "red")
}
```

```{r}
#Compare ARIMA50 ACFs
sims = 5
ACF = acf(data$gdp.change, plot = "FALSE")
plot(ACF$lag ,ACF$acf , type = "l", lwd = 6)

for( i in 1: sims)
{
   ACF2 = acf(gen.aruma.wge(319, phi = ARIMA50$phi, plot ="FALSE"), plot = "FALSE")
   lines(ACF2$lag ,ACF2$acf, lwd = 2, col = "red")
}
```


```{r}
#Compare Generated Realizations 
ARIMA50gen = gen.aruma.wge(297,phi = ARIMA50$phi, vara = ARIMA50$avar)
plotts.sample.wge(ARIMA50gen)
```

# ***Model ID ARUMA(1,1,) S=9***
```{r}
# overfit for seasonality, we get system frequency 0.1101 associated with period 9. From frequency window we see a strong peak at 0.1101 which indicates period at 9.
plotts.sample.wge(x)
est.ar.wge(data$gdp.change,p = 12) 

```


```{r}

#Transform  data with “seasonal difference”, which appears to be stationary, we'll find a stationary model for this realization
x=data$gdp.change
# difference the data
d1=artrans.wge(x,phi.tr=1)
#we try seasonal model with s=9
d1.9=artrans.wge(d1,phi.tr=c(0,0,0,0,0,0,0,0,1))
```


```{r}
#Use tswge to model the transformed data, d1.9
aic5.wge(d1.9,p=0:5,q=0:5)
# aic picks an ARMA(1,1) as the first choice
```


```{r}
#In order to see if a lower order model could satisfactorily model the data, we use BIC
aic5.wge(d1.9,p=0:5,q=0:5,type='bic')
#BIC picks ARMA(1,1),We decide to use the ARMA(1,1) model chosen by AIC and BIC
```
```{r}
# AIC and BIC picks p=5
fitaruma=arima(data$gdp.change,order=c(5,1,0),xreg=cbind(data$GDP.per.capita,data$Income.receipt,data$gross.income))
fitaruma
AIC(fitarima) #1718.626
```

```{r}
#We estimate the parameters of the ARMA(1,1) model using est.ar.wge
x_9_arma=est.arma.wge(d1.9, p=1,q=1)
```





```{r}
ljung.wge(x_9_arma$res)
ljung.wge(x_9_arma$res, K = 48)
f_x9arma = fore.aruma.wge(data$gdp.change,s = 9,phi =x_9_arma$phi,n.ahead =2,limits = F, lastn = T)

ASE_x9arma= mean((data$gdp.change[(length(x)-4):length(x)] - f_x9arma$f)^2)

ASE_x9arma
```
```{r}
#Compare Spectral Densities
sims = 5
SpecDen = parzen.wge(data$gdp.change, plot = "FALSE")
plot(SpecDen$freq,SpecDen$pzgram, type = "l", lwd = 6)

for( i in 1: sims)
{
   SpecDen4 = parzen.wge(gen.aruma.wge(297, phi = x_9_arma$phi,s=9, plot ="FALSE"), plot = "FALSE")
   lines(SpecDen4$freq,SpecDen4$pzgram, lwd = 2, col = "red")
}
```


```{r}
#Compare ACFs
sims = 5
ACF = acf(data$gdp.change, plot = "FALSE")
plot(ACF$lag ,ACF$acf , type = "l", lwd = 6)

for( i in 1: sims)
{
   ACF5 = acf(gen.aruma.wge(297, phi = x_9_arma$phi,s=9, plot = "FALSE"), plot = "FALSE")
   lines(ACF5$lag ,ACF5$acf, lwd = 2, col = "red")
}
```


# ***Summary***

* GDP data is very difficult to predict, models are not able to capture variance in this data.
* ARIMA non-stationary model shows better performance.
* ASE lower for ARIMA than ARMA and ARUMA.
* We’ll use multivariate time series and neural network to analyze the GDP change, hopefully we will be able to improve our model.


